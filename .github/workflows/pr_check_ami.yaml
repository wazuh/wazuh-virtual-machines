run-name: PR Check AMI - ${{ github.event.pull_request.title }} - Branch ${{ github.head_ref }}
name: PR Check - AMI Build & Test

on:
  pull_request:
    types: [ready_for_review, synchronize]
    paths:
      - 'configurer/**'
      - 'generic/**'
      - 'provisioner/**'
      - 'models/**'
      - 'utils/**'

permissions:
  id-token: write
  contents: read
  pull-requests: write

jobs:
  get_pr_info:
    if: ${{ !github.event.pull_request.draft }}
    runs-on: ubuntu-latest
    outputs:
      issue_url: ${{ steps.get_issue.outputs.issue_url }}
    steps:
      - name: Get linked issue from PR
        id: get_issue
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          ISSUE_URL=$(gh api graphql -f query='
            query {
              repository(owner: "${{ github.repository_owner }}", name: "${{ github.event.repository.name }}") {
                pullRequest(number: ${{ github.event.pull_request.number }}) {
                  closingIssuesReferences(first: 1) {
                    nodes {
                      url
                    }
                  }
                }
              }
            }
          ' --jq '.data.repository.pullRequest.closingIssuesReferences.nodes[0].url // empty' 2>/dev/null || true)

          if [ -n "$ISSUE_URL" ]; then
            echo "Found linked issue: $ISSUE_URL"
          else
            echo "No linked issue found"
          fi
          echo "issue_url=${ISSUE_URL}" >> $GITHUB_OUTPUT

  build_ami:
    needs: get_pr_info
    uses: ./.github/workflows/packages_builder_ami.yaml
    with:
      id: "pr-check-${{ github.event.pull_request.number }}"
      wazuh_virtual_machines_reference: ${{ github.head_ref }}
      wazuh_automation_reference: 'change/548-use-test-module-from-automation'
      is_stage: true
      ami_revision: 'check-pr'
      wazuh_package_type: dev
      architecture: '["amd64", "arm64"]'
      commit_list: '["latest", "latest", "latest", "latest", "latest"]'
      customizer_debug: false
      destroy: true
      issue: ${{ needs.get_pr_info.outputs.issue_url }}
    secrets: inherit

  test_ami_amd64:
    needs: build_ami
    if: ${{ needs.build_ami.outputs.ami_id_amd64 != '' }}
    uses: ./.github/workflows/test-vm.yaml
    with:
      WAZUH_VIRTUAL_MACHINES_REFERENCE: ${{ github.head_ref }}
      WAZUH_AUTOMATION_REFERENCE: 'change/548-use-test-module-from-automation'
      test_type: ami
      host: ${{ needs.build_ami.outputs.ami_id_amd64 }}
      TESTS: ALL
      log_level: INFO
    secrets: inherit

  test_ami_arm64:
    needs: build_ami
    if: ${{ needs.build_ami.outputs.ami_id_arm64 != '' }}
    uses: ./.github/workflows/test-vm.yaml
    with:
      WAZUH_VIRTUAL_MACHINES_REFERENCE: ${{ github.head_ref }}
      WAZUH_AUTOMATION_REFERENCE: 'change/548-use-test-module-from-automation'
      test_type: ami
      host: ${{ needs.build_ami.outputs.ami_id_arm64 }}
      TESTS: ALL
      log_level: INFO
    secrets: inherit
