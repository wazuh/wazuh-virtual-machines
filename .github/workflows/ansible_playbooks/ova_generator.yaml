- hosts: all
  become: true

  tasks:
    - name: Update all the packages
      yum:
        name: '*'
        state: latest

    - name: Install pip
      yum:
        name: python3-pip
        state: present

    - name: Download VirtualBox installer script
      get_url:
        url: https://download.virtualbox.org/virtualbox/7.1.4/VirtualBox-7.1.4-165100-Linux_amd64.run
        dest: /tmp/VirtualBox.run

    - name: Make the installer script executable
      file:
        path: /tmp/VirtualBox.run
        mode: '0755'

    - name: Install required packages for building kernel modules
      yum:
        name:
          - kernel-devel
          - kernel-headers
          - dkms
          - elfutils-libelf-devel
          - gcc
          - make
          - perl
        state: present
      become: true

    - name: Run VirtualBox installer script
      command: bash /tmp/VirtualBox.run
      become: true

    - name: Update all the packages
      yum:
        name: '*'
        state: latest

    - name: Install Development tools
      command: dnf groupinstall "Development Tools" -y
      become: true

    - name: Rebuild the VirtualBox kernel modules
      command: /sbin/vboxconfig

    - name: Install utilities for Vagrant
      command: yum install -y yum-utils shadow-utils

    - name: Add the Vagrant repository
      command: yum-config-manager --add-repo https://rpm.releases.hashicorp.com/AmazonLinux/hashicorp.repo

    - name: Install Vagrant
      command: yum -y install vagrant

    - name: Install git
      shell: yum install -y git
      become: true

    - name: Create directory for the base VM
      file:
        path: "/tmp/ova_directory"
        state: directory
        mode: '0755'

    - name: Download the Wazuh virtual machines repository
      git:
        repo: "{{ wvm_repository }}"
        version: "{{ wvm_branch }}"
        dest: "/tmp/wazuh-virtual-machines"
      register: clone_result
      retries: 6
      delay: 10
      until: clone_result is success

    - name: Create base box
      shell: "./generate_base_box.sh"
      args:
        chdir: "/tmp/wazuh-virtual-machines/ova/workflow_assets"
      register: base_box_creation_result
      async: 1800
      poll: 0
      ignore_errors: yes

    - name: Wait for the base box creation to finish
      async_status:
        jid: "{{ base_box_creation_result.ansible_job_id }}"
      register: job_result
      until: job_result.finished
      retries: 30
      delay: 60

    - name: Add the created box
      shell: "vagrant box add --name al2023 /tmp/wazuh-virtual-machines/ova/workflow_assets/al2023.box"

    - name: Destroy previous machines
      shell: |
        #!/bin/bash
        cd /tmp/wazuh-virtual-machines/ova/workflow_assets
        machines=$(vagrant global-status --prune | awk '/running|saved|poweroff/ {print $1}')
        if [ -n "$machines" ]; then
          for id in $machines; do
            vagrant destroy -f $id
          done
        fi
      args:
        executable: /bin/bash
      become: true

    # ==========================================
    # VAGRANT UP - CAMBIO MÍNIMO: SOLO LOG A ARCHIVO
    # ==========================================

    - name: Run vagrant up
      shell: |
        #!/bin/bash
        MAX_RETRIES=5
        attempts=0
        cd /tmp/wazuh-virtual-machines/ova/workflow_assets

        while true; do
          ((attempts++))
          echo "Attempt $attempts at $(date)"

          # Log to file sin saturar SSH
          if VAGRANT_LOG=info vagrant up > /tmp/vagrant_${attempts}.log 2>&1; then
            echo "Success on attempt $attempts"
            break
          else
            echo "Failed on attempt $attempts"
            if [ $attempts -eq $MAX_RETRIES ]; then
              echo "Max attempts reached"
              echo "Last 30 lines of log:"
              tail -30 /tmp/vagrant_${attempts}.log
              exit 1
            fi
            vagrant destroy -f
          fi
        done
      args:
        executable: /bin/bash
      async: 3600  # 1 hora
      poll: 0
      register: vagrant_up_result
      become: true

    - name: Wait for vagrant up to finish
      async_status:
        jid: "{{ vagrant_up_result.ansible_job_id }}"
      register: job_result
      until: job_result.finished
      retries: 60  # 60 minutos
      delay: 60

    - name: Show vagrant up result
      debug:
        var: job_result.stdout_lines
      when: job_result.stdout_lines is defined

    # ==========================================
    # GUARDAR LOGS PARA ANÁLISIS (SOLO SI FALLA)
    # ==========================================

    - name: Collect vagrant logs if failed
      shell: |
        if [ -f /tmp/vagrant_*.log ]; then
          echo "=== Vagrant logs available ==="
          ls -lh /tmp/vagrant_*.log
          echo ""
          echo "=== Last attempt log (last 50 lines) ==="
          tail -50 /tmp/vagrant_*.log | tail -1
        fi
      register: vagrant_logs
      when: job_result.rc != 0
      ignore_errors: yes

    - name: Show vagrant logs
      debug:
        var: vagrant_logs.stdout_lines
      when:
        - job_result.rc != 0
        - vagrant_logs.stdout_lines is defined

    # ==========================================
    # CONTINUAR NORMAL SI VAGRANT UP FUNCIONÓ
    # ==========================================

    - name: Copy the Python script to the VM
      shell: |
        cd /tmp/wazuh-virtual-machines/ova/workflow_assets
        vagrant plugin install vagrant-scp
        vagrant scp ova_configurer.py :/tmp/ova_configurer.py
      args:
        chdir: "/tmp/wazuh-virtual-machines/ova/workflow_assets"
      become: true

    - name: Execute Python script in the VM
      shell: "vagrant ssh -c 'sudo python3 /tmp/ova_configurer.py --wia_branch {{ wia_branch }} --wvm_branch {{ wvm_branch }} --repository {{ repository }} --debug {{ debug}}'"
      args:
        chdir: "/tmp/wazuh-virtual-machines/ova/workflow_assets"
      register: python_script_result
      async: 1800
      poll: 0

    - name: Wait for the Python script to finish
      async_status:
        jid: "{{ python_script_result.ansible_job_id }}"
      register: job_result
      until: job_result.finished
      retries: 30
      delay: 60

    - name: Stop the VM
      shell: "vagrant halt"
      args:
        chdir: "/tmp/wazuh-virtual-machines/ova/workflow_assets"

    # ==========================================
    # AÑADIR RED PRIVADA DESPUÉS DE HALT
    # ==========================================

    - name: Add private network to VM
      shell: |
        # Verificar/crear host-only interface
        if ! vboxmanage list hostonlyifs | grep -q vboxnet0; then
          vboxmanage hostonlyif create
        fi

        # Añadir NIC2
        vboxmanage modifyvm ova_base --nic2 hostonly
        vboxmanage modifyvm ova_base --cableconnected2 on

        echo "Network configured"
        vboxmanage showvminfo ova_base | grep "NIC 2"

    # ==========================================
    # EXPORT OVA
    # ==========================================

    - name: Export the VM to OVA
      shell: "vboxmanage export ova_base --output /home/ec2-user/{{ filename_ova }}"
      register: export_result
      async: 1800
      poll: 0

    - name: Wait for export the OVA
      async_status:
        jid: "{{ export_result.ansible_job_id }}"
      register: job_result
      until: job_result.finished
      retries: 30
      delay: 60

    - name: Change permissions to the OVA file
      file:
        path: /home/ec2-user/{{ filename_ova }}
        mode: '0755'