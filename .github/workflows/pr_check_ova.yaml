run-name: PR Check OVA - ${{ github.event.pull_request.title }} - Branch ${{ github.head_ref }}
name: PR Check - OVA Build & Test

on:
  issue_comment:
    types: [created]

permissions:
  id-token: write
  contents: read
  pull-requests: write
  issues: write

jobs:
  get_pr_info:
    if: |
      github.event.issue.pull_request &&
      github.event.issue.state == 'open' &&
      !github.event.issue.draft &&
      (contains(github.event.comment.body, '/test-integration') ||
       contains(github.event.comment.body, '/test-ova'))
    runs-on: ubuntu-latest
    outputs:
      pr_number: ${{ steps.pr_data.outputs.pr_number }}
      pr_head_ref: ${{ steps.pr_data.outputs.pr_head_ref }}
    steps:
      - name: Extract PR data
        id: pr_data
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            # Pull request event
            PR_NUMBER="${{ github.event.pull_request.number }}"
            PR_HEAD_REF="${{ github.head_ref }}"
          else
            # Issue comment event
            PR_NUMBER="${{ github.event.issue.number }}"
            # Fetch PR head ref from API
            PR_DATA=$(gh api repos/${{ github.repository }}/pulls/${PR_NUMBER})
            PR_HEAD_REF=$(echo "$PR_DATA" | jq -r '.head.ref')
          fi

          echo "pr_number=${PR_NUMBER}" >> $GITHUB_OUTPUT
          echo "pr_head_ref=${PR_HEAD_REF}" >> $GITHUB_OUTPUT
          echo "PR Number: ${PR_NUMBER}"
          echo "PR Head Ref: ${PR_HEAD_REF}"

  build_ova:
    needs: get_pr_info
    uses: ./.github/workflows/builder_OVA.yaml
    with:
      id: "pr-check-${{ needs.get_pr_info.outputs.pr_number }}"
      wazuh_virtual_machines_reference: ${{ needs.get_pr_info.outputs.pr_head_ref }}
      wazuh_automation_reference: 'main'
      is_stage: true
      ova_revision: '0'
      wazuh_package_type: dev
      commit_list: '["latest", "latest", "latest", "latest"]'
      destroy: true
      checksum: false
    secrets: inherit

  test_ova:
    needs: [get_pr_info, build_ova]
    uses: ./.github/workflows/test-vm.yaml
    with:
      WAZUH_VIRTUAL_MACHINES_REFERENCE: ${{ needs.get_pr_info.outputs.pr_head_ref }}
      WAZUH_AUTOMATION_REFERENCE: 'main'
      test_type: ova
      wazuh_package_type: dev
      commit_list: '["latest", "latest", "latest", "latest"]'
      TESTS: ALL
      log_level: INFO
    secrets: inherit
